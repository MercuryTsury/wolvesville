<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Wolvesville Clan Dashboard</title>
    <style>
        :root { --bg: #0b0e14; --card: #151921; --accent: #4e5efc; --text: #e0e6ed; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 10px; }
        .tab-btn { background: var(--card); border: none; color: white; padding: 10px 20px; cursor: pointer; border-radius: 5px; transition: 0.3s; white-space: nowrap;}
        .tab-btn.active { background: var(--accent); }
        .controls { background: var(--card); padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        input { background: #1b222c; color: white; border: 1px solid #303e4d; padding: 8px; border-radius: 4px; }
        .table-container { background: var(--card); border-radius: 8px; overflow: auto; max-height: 75vh; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        table { width: 100%; border-collapse: collapse; min-width: 1100px; }
        th { background: #1c232e; padding: 12px; text-align: left; cursor: pointer; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--accent); }
        td { padding: 10px 12px; border-bottom: 1px solid #232d3a; font-size: 0.85em; }
        tr:hover { background: #1b222c; }
        .lvl { color: #fbc02d; font-weight: bold; }
        .pct { color: #2ecc71; font-weight: bold; }
        .btn-load { background: var(--accent); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

    <h2>üê∫ Kunugigaoka Dashboard (IONOS)</h2>

    <div class="controls">
        <label>Format Date (JJ-MM-AAAA_HH-MM) :</label>
        <input type="text" id="dateInput" placeholder="ex: 10-01-2026_10-39">
        <button class="btn-load" onclick="loadData()">Charger les donn√©es</button>
        <small>Note: Le fichier doit exister dans /data/clan/ et /data/membres/nom/</small>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('general', this)">1. G√©n√©ral</button>
        <button class="tab-btn" onclick="switchTab('global', this)">2. Global</button>
        <button class="tab-btn" onclick="switchTab('village', this)">3. Village</button>
        <button class="tab-btn" onclick="switchTab('loups', this)">4. Loups</button>
        <button class="tab-btn" onclick="switchTab('vote', this)">5. Vote</button>
        <button class="tab-btn" onclick="switchTab('solo', this)">6. Solo</button>
        <button class="tab-btn" onclick="switchTab('clan', this)">7. Clan</button>
    </div>

    <div class="table-container">
        <table id="mainTable">
            <thead><tr id="tableHead"></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

<script>
    let currentData = [];
    let currentTab = 'general';

    const config = {
        general: [
            { label: 'Utilisateur', key: 'nom_utilisateur' },
            { label: 'Description', key: 'description' },
            { label: 'Niveau', key: 'niveau', class: 'lvl' },
            { label: 'Cr√©ation', key: 'date_creation', format: 'date' },
            { label: 'Roses R.', key: 'rose_recus' },
            { label: 'Roses E.', key: 'rose_envoyees' },
            { label: 'Victoires %', key: 'statistiques.statistiques_global.ratio_victoires', format: 'pct' }
        ],
        global: [
            { label: 'Utilisateur', key: 'nom_utilisateur' },
            { label: 'Niveau', key: 'niveau' },
            { label: 'Victoires', key: 'statistiques.statistiques_global.total_victoires' },
            { label: 'D√©faites', key: 'statistiques.statistiques_global.total_defaites' },
            { label: 'Nuls', key: 'statistiques.statistiques_global.total_nuls' },
            { label: 'Suicides', key: 'statistiques.statistiques_global.total_suicides' },
            { label: 'Vic %', key: 'statistiques.statistiques_global.ratio_victoires', format: 'pct' },
            { label: 'Def %', key: 'statistiques.statistiques_global.ratio_defaites', format: 'pct' },
            { label: 'Sui %', key: 'statistiques.statistiques_global.ratio_suicides', format: 'pct' },
            { label: 'Surv√©cu', key: 'statistiques.statistiques_global.total_parties_survecu' },
            { label: 'Temps (min)', key: 'statistiques.statistiques_global.total_minutes_jouer' }
        ],
        village: [
            { label: 'Utilisateur', key: 'nom_utilisateur' },
            { label: 'Niveau', key: 'niveau' },
            { label: 'Victoires', key: 'statistiques.statistiques_village.total_victoires' },
            { label: 'D√©faites', key: 'statistiques.statistiques_village.total_defaites' },
            { label: 'Vic %', key: 'statistiques.statistiques_village.ratio_victoires', format: 'pct' }
        ],
        loups: [
            { label: 'Utilisateur', key: 'nom_utilisateur' },
            { label: 'Niveau', key: 'niveau' },
            { label: 'Victoires', key: 'statistiques.statistiques_loups.total_victoires' },
            { label: 'D√©faites', key: 'statistiques.statistiques_loups.total_defaites' },
            { label: 'Vic %', key: 'statistiques.statistiques_loups.ratio_victoires', format: 'pct' }
        ],
        vote: [
            { label: 'Utilisateur', key: 'nom_utilisateur' },
            { label: 'Niveau', key: 'niveau' },
            { label: 'Victoires', key: 'statistiques.statistiques_vote.total_victoires' },
            { label: 'D√©faites', key: 'statistiques.statistiques_vote.total_defaites' },
            { label: 'Vic %', key: 'statistiques.statistiques_vote.ratio_victoires', format: 'pct' }
        ],
        solo: [
            { label: 'Utilisateur', key: 'nom_utilisateur' },
            { label: 'Niveau', key: 'niveau' },
            { label: 'Victoires', key: 'statistiques.statistiques_solo.total_victoires' },
            { label: 'D√©faites', key: 'statistiques.statistiques_solo.total_defaites' },
            { label: 'Vic %', key: 'statistiques.statistiques_solo.ratio_victoires', format: 'pct' }
        ],
        clan: [
            { label: 'Utilisateur', key: 'nom_utilisateur' },
            { label: 'Gold Week', key: 'clan.donations.gold.week' },
            { label: 'Gold Month', key: 'clan.donations.gold.month' },
            { label: 'Gold All', key: 'clan.donations.gold.allTime' },
            { label: 'Gems All', key: 'clan.donations.gems.allTime' },
            { label: 'XP Clan', key: 'clan.xp_clan_total' },
            { label: 'Staff', key: 'clan.staff', format: 'bool' },
            { label: 'Qu√™tes Or', key: 'clan.quetes.nombre_or' }
        ]
    };

    const getVal = (obj, path) => path.split('.').reduce((a, b) => (a ? a[b] : null), obj);

    async function loadData() {
        const date = document.getElementById('dateInput').value;
        if(!date) { alert("Veuillez entrer une date au format JJ-MM-AAAA_HH-MM"); return; }
        
        const body = document.getElementById('tableBody');
        body.innerHTML = "<tr><td colspan='10'>Chargement des donn√©es depuis le FTP...</td></tr>";

        try {
            // 1. Charger le fichier clan
            const clanResp = await fetch(`./data/clan/${date}.json`);
            if(!clanResp.ok) throw new Error("Fichier clan introuvable pour cette date.");
            const clanData = await clanResp.json();

            // 2. Charger chaque membre
            const membersPromises = clanData.membres.map(async (name) => {
                try {
                    const mResp = await fetch(`./data/membres/${name}/${date}.json`);
                    return mResp.ok ? await mResp.json() : null;
                } catch(e) { return null; }
            });

            const results = await Promise.all(membersPromises);
            currentData = results.filter(r => r !== null);
            render();
        } catch (e) {
            body.innerHTML = `<tr><td colspan='10' style="color:red">Erreur : ${e.message}</td></tr>`;
        }
    }

    function switchTab(tab, btn) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentTab = tab;
        render();
    }

    function render() {
        if(currentData.length === 0) return;
        const columns = config[currentTab];
        document.getElementById('tableHead').innerHTML = columns.map(col => `<th onclick="sortTable('${col.key}')">${col.label} ‚Üï</th>`).join('');
        
        document.getElementById('tableBody').innerHTML = currentData.map(player => {
            return `<tr>${columns.map(col => {
                let val = getVal(player, col.key);
                let display = val;
                if (col.format === 'pct') display = `<span class="pct">${(parseFloat(val || 0) * 100).toFixed(1)}%</span>`;
                if (col.format === 'date') display = new Date(val).toLocaleDateString();
                if (col.format === 'bool') display = val ? '‚úÖ' : '‚ùå';
                return `<td>${display ?? '-'}</td>`;
            }).join('')}</tr>`;
        }).join('');
    }

    let sortOrder = 1;
    function sortTable(key) {
        sortOrder *= -1;
        currentData.sort((a, b) => {
            let valA = getVal(a, key);
            let valB = getVal(b, key);
            return (typeof valA === 'string' ? valA.localeCompare(valB) : (valA - valB)) * sortOrder;
        });
        render();
    }
</script>
</body>
</html>
