<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Wolvesville Clan Dashboard</title>
    <style>
        :root { --bg: #0b0e14; --card: #151921; --accent: #4e5efc; --text: #e0e6ed; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        
        .controls { background: var(--card); padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        select { background: #1b222c; color: white; border: 1px solid #303e4d; padding: 10px; border-radius: 4px; min-width: 200px; cursor: pointer; }
        
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { background: var(--card); border: none; color: white; padding: 12px 20px; cursor: pointer; border-radius: 5px; transition: 0.3s; }
        .tab-btn.active { background: var(--accent); font-weight: bold; }

        .table-container { background: var(--card); border-radius: 8px; overflow: auto; max-height: 70vh; border: 1px solid #232d3a; }
        table { width: 100%; border-collapse: collapse; min-width: 1100px; }
        th { background: #1c232e; padding: 12px; text-align: left; cursor: pointer; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--accent); }
        td { padding: 10px 12px; border-bottom: 1px solid #232d3a; font-size: 0.85em; }
        tr:hover { background: #1b222c; }
        
        .pct { color: #2ecc71; font-weight: bold; }
        .lvl { color: #fbc02d; font-weight: bold; }
        .loading { color: var(--accent); font-style: italic; }
    </style>
</head>
<body>

    <h2>üê∫ Kunugigaoka Dashboard</h2>

    <div class="controls">
        <label>S√©lectionner une sauvegarde :</label>
        <select id="dateSelect" onchange="loadData()">
            <option value="">Chargement des dates...</option>
        </select>
        <span id="statusMsg"></span>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('general', this)">G√©n√©ral</button>
        <button class="tab-btn" onclick="switchTab('global', this)">Stats Global</button>
        <button class="tab-btn" onclick="switchTab('village', this)">Village</button>
        <button class="tab-btn" onclick="switchTab('loups', this)">Loups</button>
        <button class="tab-btn" onclick="switchTab('vote', this)">Vote</button>
        <button class="tab-btn" onclick="switchTab('solo', this)">Solo</button>
        <button class="tab-btn" onclick="switchTab('clan', this)">Clan</button>
    </div>

    <div class="table-container">
        <table id="mainTable">
            <thead><tr id="tableHead"></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

<script>
    let currentData = [];
    let currentTab = 'general';

    // Configuration identique √† la pr√©c√©dente (ratios, dates, bool√©ens)
    const config = {
        general: [
            { label: 'Utilisateur', key: 'nom_utilisateur' },
            { label: 'Description', key: 'description' },
            { label: 'Niveau', key: 'niveau', class: 'lvl' },
            { label: 'Cr√©ation', key: 'date_creation', format: 'date' },
            { label: 'üåπ Re√ßues', key: 'roses.recus' },
            { label: 'üåπ Envoy√©es', key: 'roses.envoyees' },
            { label: 'Ratio roses', key: 'roses.ratio', format: 'pct' }
        ],
        global: [
            { label: 'Utilisateur', key: 'nom_utilisateur' },
            { label: 'Niveau', key: 'niveau' },
            { label: 'Victoires', key: 'statistiques.statistiques_global.total_victoires' },
            { label: 'D√©faites', key: 'statistiques.statistiques_global.total_defaites' },
            { label: 'Nuls', key: 'statistiques.statistiques_global.total_nuls' },
            { label: 'Suicides', key: 'statistiques.statistiques_global.total_suicides' },
            { label: 'Vic %', key: 'statistiques.statistiques_global.ratio_victoires', format: 'pct' },
            { label: 'Def %', key: 'statistiques.statistiques_global.ratio_defaites', format: 'pct' },
            { label: 'Sui %', key: 'statistiques.statistiques_global.ratio_suicides', format: 'pct' },
            { label: 'Surv√©cu', key: 'statistiques.statistiques_global.total_parties_survecu' },
            { label: 'Minutes', key: 'statistiques.statistiques_global.total_minutes_jouer' }
        ],
        village: [
            { label: 'Utilisateur', key: 'nom_utilisateur' },
            { label: 'Victoires', key: 'statistiques.statistiques_village.total_victoires' },
            { label: 'D√©faites', key: 'statistiques.statistiques_village.total_defaites' },
            { label: 'Ratio %', key: 'statistiques.statistiques_village.ratio_victoires', format: 'pct' }
        ],
        loups: [
            { label: 'Utilisateur', key: 'nom_utilisateur' },
            { label: 'Victoires', key: 'statistiques.statistiques_loups.total_victoires' },
            { label: 'D√©faites', key: 'statistiques.statistiques_loups.total_defaites' },
            { label: 'Ratio %', key: 'statistiques.statistiques_loups.ratio_victoires', format: 'pct' }
        ],
        vote: [
            { label: 'Utilisateur', key: 'nom_utilisateur' },
            { label: 'Victoires', key: 'statistiques.statistiques_vote.total_victoires' },
            { label: 'D√©faites', key: 'statistiques.statistiques_vote.total_defaites' },
            { label: 'Ratio %', key: 'statistiques.statistiques_vote.ratio_victoires', format: 'pct' }
        ],
        solo: [
            { label: 'Utilisateur', key: 'nom_utilisateur' },
            { label: 'Victoires', key: 'statistiques.statistiques_solo.total_victoires' },
            { label: 'D√©faites', key: 'statistiques.statistiques_solo.total_defaites' },
            { label: 'Ratio %', key: 'statistiques.statistiques_solo.ratio_victoires', format: 'pct' }
        ],
        clan: [
            { label: 'Utilisateur', key: 'nom_utilisateur' },
            { label: 'Gold All', key: 'clan.donations.gold.allTime' },
            { label: 'Gems All', key: 'clan.donations.gems.allTime' },
            { label: 'XP Total', key: 'clan.xp_clan_total' },
            { label: 'Staff', key: 'clan.staff', format: 'bool' },
            { label: 'Qu√™tes Or', key: 'clan.quetes.nombre_or' }
        ]
    };

    const getVal = (obj, path) => path.split('.').reduce((a, b) => (a ? a[b] : null), obj);

    async function init() {
        try {
            // On charge le fichier JSON fixe au lieu du PHP
            const resp = await fetch('dates.json'); 
            const dates = await resp.json();
            const select = document.getElementById('dateSelect');
            select.innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join('');
            if(dates.length > 0) loadData();
        } catch (e) {
            document.getElementById('statusMsg').innerHTML = "Cr√©ez un fichier dates.json √† la racine.";
        }
    }

    async function loadData() {
        const date = document.getElementById('dateSelect').value;
        const body = document.getElementById('tableBody');
        body.innerHTML = "<tr><td colspan='10' class='loading'>Chargement des donn√©es...</td></tr>";

        try {
            const clanResp = await fetch(`./data/clan/${date}.json`);
            const clanData = await clanResp.json();

            const promises = clanData.membres.map(name => 
                fetch(`./data/membres/${name}/${date}.json`).then(r => r.ok ? r.json() : null).catch(() => null)
            );

            const results = await Promise.all(promises);
            currentData = results.filter(r => r !== null);
            render();
        } catch (e) {
            body.innerHTML = "<tr><td colspan='10' style='color:red'>Erreur : Fichier introuvable.</td></tr>";
        }
    }

    function switchTab(tab, btn) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentTab = tab;
        render();
    }

    function render() {
        if(!currentData.length) return;
        const columns = config[currentTab];
        document.getElementById('tableHead').innerHTML = columns.map(col => `<th onclick="sortTable('${col.key}')">${col.label} ‚Üï</th>`).join('');
        
        document.getElementById('tableBody').innerHTML = currentData.map(player => {
            return `<tr>${columns.map(col => {
                let val = getVal(player, col.key);
                let display = val;
                if (col.format === 'pct') display = `<span class="pct">${(parseFloat(val || 0) * 100).toFixed(1)}%</span>`;
                if (col.format === 'date') display = new Date(val).toLocaleDateString();
                if (col.format === 'bool') display = val ? '‚úÖ' : '‚ùå';
                return `<td>${display ?? '-'}</td>`;
            }).join('')}</tr>`;
        }).join('');
    }

    let sortOrder = 1;
    function sortTable(key) {
        sortOrder *= -1;
        currentData.sort((a, b) => {
            let valA = getVal(a, key);
            let valB = getVal(b, key);
            return (typeof valA === 'string' ? valA.localeCompare(valB) : (valA - valB)) * sortOrder;
        });
        render();
    }

    init();
</script>
</body>
</html>
